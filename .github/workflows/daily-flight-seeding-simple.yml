name: Daily Flight Seeding (Simple)

on:
  schedule:
    # Run every day at 2:00 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual triggering

env:
  NODE_VERSION: "20"

jobs:
  seed-flights:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate Prisma client
        run: yarn generate-types

      - name: Setup environment variables
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "DIRECT_URL=${{ secrets.DIRECT_URL }}" >> .env

      - name: Test database connection
        run: |
          echo "ðŸ” Testing database connection..."
          npx prisma db pull --force
          echo "âœ… Database connection successful"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}

      - name: Run flight seeding
        run: |
          echo "ðŸš€ Starting flight seeding..."
          yarn seedFlights
          echo "âœ… Flight seeding completed successfully"
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}

      - name: Create summary
        if: always()
        run: |
          echo "## ðŸš€ Daily Flight Seeding Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completed at**: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Result**: Flights seeded successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ New flights have been added to the database" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Result**: Seeding failed - check logs for details" >> $GITHUB_STEP_SUMMARY
          fi
